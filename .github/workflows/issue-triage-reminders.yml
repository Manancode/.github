name: Issue Triage Reminders

on:
  schedule:
    - cron: '0 0 * * *'
  workflow_dispatch:

jobs:
  check-untriaged-issues:
    if: startsWith(github.repository, 'asyncapi/') || github.repository == 'Manancode/.github'
    runs-on: ubuntu-latest
    steps:
      - uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GH_TOKEN }}
          script: |
            const now = new Date();
            const twoWeeksAgo = new Date(now - 14 * 24 * 60 * 60 * 1000);
            const threeWeeksAgo = new Date(now - 21 * 24 * 60 * 60 * 1000);
            const fiveWeeksAgo = new Date(now - 35 * 24 * 60 * 60 * 1000);
            const sixWeeksAgo = new Date(now - 42 * 24 * 60 * 60 * 1000);
            const sixtyDaysAgo = new Date(now - 60 * 24 * 60 * 60 * 1000);

            const { data: issues } = await github.rest.issues.listForRepo({
              owner: context.repo.owner,
              repo: context.repo.repo,
              state: 'open',
              labels: 'status/to-be-triaged',
              per_page: 100
            });

            for (const issue of issues) {
              if (issue.pull_request) continue;

              const issueNumber = issue.number;
              const labels = issue.labels.map(l => l.name);

              if (labels.includes('keep-open')) {
                console.log(`Issue #${issueNumber} has keep-open label - skipping`);
                continue;
              }

              const labelEvents = await github.rest.issues.listEvents({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: issueNumber,
                per_page: 100
              });

              const triageLabelAdded = labelEvents.data.find(
                e => e.event === 'labeled' && e.label.name === 'status/to-be-triaged'
              );

              if (!triageLabelAdded) {
                console.log(`Issue #${issueNumber} has no label event history - using issue creation date`);
                const labelAddedAt = new Date(issue.created_at);
              } else {
                var labelAddedAt = new Date(triageLabelAdded.created_at);
              }

              console.log(`Issue #${issueNumber} - label added: ${labelAddedAt.toISOString()}`);

              const { data: comments } = await github.rest.issues.listComments({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: issueNumber,
                per_page: 100
              });

              const hasFirstReminder = comments.some(c => 
                c.body.includes('Reminder: This issue is awaiting triage') && 
                c.body.includes('2-3 weeks')
              );

              const hasSecondReminder = comments.some(c => 
                c.body.includes('Second reminder: This issue is still awaiting triage') &&
                c.body.includes('5-6 weeks')
              );

              const hasClosureProposal = labels.includes('bot/to-be-closed');

              if (labelAddedAt < sixtyDaysAgo && !hasClosureProposal) {
                await github.rest.issues.addLabels({
                  owner: context.repo.owner,
                  repo: context.repo.repo,
                  issue_number: issueNumber,
                  labels: ['bot/to-be-closed']
                });

                await github.rest.issues.createComment({
                  owner: context.repo.owner,
                  repo: context.repo.repo,
                  issue_number: issueNumber,
                  body: `This issue has not been triaged by a maintainer within 60 days and is being proposed for closure.\n\n@asyncapi/maintainers - Please review this issue and decide whether to:\n- Triage it by removing \`status/to-be-triaged\` and adding \`status/triaged\`\n- Close it if it's not aligned with project goals\n- Add \`keep-open\` label if it needs more time\n\nThank you! ❤️`
                });

                console.log(`Issue #${issueNumber} proposed for closure (60+ days untriaged)`);
              }
              else if (labelAddedAt < fiveWeeksAgo && labelAddedAt >= sixWeeksAgo && !hasSecondReminder) {
                await github.rest.issues.createComment({
                  owner: context.repo.owner,
                  repo: context.repo.repo,
                  issue_number: issueNumber,
                  body: `**Second reminder:** This issue is still awaiting triage from a maintainer.\n\nIt has been **5-6 weeks** since this issue was opened. If no triage occurs within the next few weeks, it may be proposed for closure.\n\nThank you for your patience! ❤️`
                });

                console.log(`Posted second reminder on issue #${issueNumber}`);
              }
              else if (labelAddedAt < twoWeeksAgo && labelAddedAt >= threeWeeksAgo && !hasFirstReminder) {
                await github.rest.issues.createComment({
                  owner: context.repo.owner,
                  repo: context.repo.repo,
                  issue_number: issueNumber,
                  body: `**Reminder:** This issue is awaiting triage from a maintainer.\n\nIt has been **2-3 weeks** since this issue was opened. A maintainer will review and triage this issue soon.\n\nThank you for your patience! ❤️`
                });

                console.log(`Posted first reminder on issue #${issueNumber}`);
              }
            }
